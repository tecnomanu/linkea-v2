# Block Development Guidelines

## Overview

This guide documents the complete process for creating a new block type in Linkea.
Use the **Calendar block** as the reference implementation.

## IMPORTANT: Centralized Configuration

**All block configuration is centralized in `resources/js/config/blockConfig.ts`**

This is the **single source of truth** for:
- Block labels and descriptions
- Icons (Lucide component + name for serialization)
- Color classes and badge styles
- Default values when creating blocks
- Input placeholders
- Visibility in selector

**DO NOT duplicate this information in other files.**

## Files to Modify/Create (Checklist)

When creating a new block, you need to touch these files in order:

### 1. Centralized Block Configuration (FIRST!)

**File:** `resources/js/config/blockConfig.ts`

- Add entry to `BLOCK_TYPES` record
- This automatically updates: BlockSelector, LinkCard, LinksTab

```typescript
// Add new block type
newblock: {
    label: "New Block",
    description: "Description for selector",
    icon: NewBlockIcon,          // Lucide component
    iconName: "new-block-icon",  // Lucide icon name for DB
    colorClass: "bg-purple-500 text-white",
    badgeClass: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400",
    hideUrlInput: true,          // Set true if no URL input needed
    titlePlaceholder: "Block Title",
    urlPlaceholder: "https://...",  // Optional
    defaults: {
        title: "Default Title",
        url: "",
        // Block-specific default values
        newBlockField: "",
    },
},
```

### 2. Types & Constants (Frontend)

**File:** `resources/js/types.ts`

- Add block type to `BlockType` union
- Add any specific types (e.g., `CalendarProvider`)
- Add optional fields to `LinkBlock` interface

```typescript
// Add to BlockType union
export type BlockType =
    | "link"
    | "newblock"; // <-- Add here

// Add specific types if needed
export type NewBlockProvider = "option1" | "option2";

// Add optional fields to LinkBlock
export interface LinkBlock {
    // ... existing fields
    newBlockField?: string;
    newBlockProvider?: NewBlockProvider;
}
```

### 3. Backend Validation

**File:** `app/Http/Requests/Panel/SaveLinksRequest.php`

- Add type to `Rule::in()` array in `rules()`
- Add validation rules for block-specific fields
- Add field mapping in `extractConfig()`

```php
// In rules():
'links.*.type' => ['required', 'string', Rule::in([
    // ...existing types
    'newblock',  // <-- Add here
])],
// Add specific field validation
'links.*.newBlockField' => 'nullable|string|max:255',

// In extractConfig():
$config = array_filter([
    // ...existing
    'new_block_field' => $link['newBlockField'] ?? null,
], fn($v) => $v !== null);
```

### 4. Backend Constants (Optional)

**File:** `app/Constants/BlockTypes.php`

```php
public const NEWBLOCK = 'newblock';

public const ALL = [
    // ...
    self::NEWBLOCK,
];
```

### 5. Validation Hook (Frontend)

**File:** `resources/js/hooks/useLinkValidation.ts`

- Add URL pattern if needed
- Update `isLinkComplete()` switch case
- Update `getValidationError()` switch case

```typescript
// Update isLinkComplete
case "newblock":
    return !!link.newBlockField;

// Update getValidationError
case "newblock":
    if (!link.newBlockField) return "Campo requerido";
    return null;
```

### 6. Configuration Component

**File:** `resources/js/Components/Panel/Links/configs/{BlockName}Config.tsx` (NEW)

```typescript
/**
 * NewBlockConfig - Configuration panel for NewBlock
 *
 * Related files:
 * - config/blockConfig.ts: Centralized block configuration
 * - types.ts: NewBlockProvider, LinkBlock
 * - blocks/NewBlockBlock.tsx: Renderer for LandingContent
 */

import { LinkBlock } from "@/types";
import React from "react";

interface NewBlockConfigProps {
    link: LinkBlock;
    onUpdate: (id: string, updates: Partial<LinkBlock>) => void;
}

export const NewBlockConfig: React.FC<NewBlockConfigProps> = ({ link, onUpdate }) => {
    return (
        <div className="space-y-5">
            {/* Configuration fields */}
        </div>
    );
};
```

### 7. Export Configuration

**File:** `resources/js/Components/Panel/Links/configs/index.ts`

```typescript
export { NewBlockConfig } from "./NewBlockConfig";
```

### 8. Link Config Dialog

**File:** `resources/js/Components/Panel/Links/LinkConfigDialog.tsx`

```typescript
import { NewBlockConfig } from "./configs";

// In renderConfigContent():
case "newblock":
    return <NewBlockConfig link={link} onUpdate={onUpdate} />;
```

### 9. Block Renderer (Public Landing)

**File:** `resources/js/Components/Shared/blocks/{BlockName}Block.tsx` (NEW)

```typescript
/**
 * NewBlockBlock - Public landing page renderer
 *
 * Related files:
 * - config/blockConfig.ts: Centralized configuration
 * - configs/NewBlockConfig.tsx: Panel configuration UI
 * - LandingContent.tsx: Parent component
 */

import { LinkBlock, UserProfile } from "@/types";
import React from "react";

interface NewBlockBlockProps {
    link: LinkBlock;
    design: UserProfile["customDesign"];
    buttonClassName: string;
    buttonStyle: React.CSSProperties;
    isPreview?: boolean;
    onClick?: (e: React.MouseEvent) => void;
    animationDelay?: number;
    roundingClass?: string;
}

export const NewBlockBlock: React.FC<NewBlockBlockProps> = ({
    link,
    design,
    buttonClassName,
    buttonStyle,
    isPreview = false,
    onClick,
    animationDelay = 0,
    roundingClass = "rounded-[20px]",
}) => {
    // Block implementation
};

export default NewBlockBlock;
```

### 10. Export Block Renderer

**File:** `resources/js/Components/Shared/blocks/index.ts`

```typescript
export { NewBlockBlock } from "./NewBlockBlock";
```

### 11. Landing Content Integration

**File:** `resources/js/Components/Shared/LandingContent.tsx`

```typescript
import { NewBlockBlock } from "./blocks";

// In the activeLinks.map():
if (link.type === "newblock") {
    return (
        <NewBlockBlock
            key={link.id}
            link={link}
            design={customDesign}
            buttonClassName={buttonClass}
            buttonStyle={buttonStyles}
            isPreview={isPreview}
            onClick={() => handleLinkClick(link.id)}
            animationDelay={index * 50}
            roundingClass={getRounding()}
        />
    );
}
```

### 12. Dashboard Payload Serialization (CRITICAL)

**File:** `resources/js/Pages/Panel/Dashboard.tsx`

- **CRITICAL:** Update `linksPayload` to include ALL new config fields
- This is how data is sent to the backend when saving!

```typescript
// In linksPayload useMemo - add ALL new block fields:
const linksPayload = useMemo(
    () => ({
        links: links.map((link, index) => ({
            // ... existing fields
            newBlockField: link.newBlockField,
            newBlockProvider: link.newBlockProvider,
        })),
    }),
    [links]
);
```

### 13. Dashboard Initial Data Mapping

**File:** `resources/js/Pages/Panel/Dashboard.tsx`

```typescript
const initialLinks: LinkBlock[] = serverLinks.map((link) => ({
    // ... existing fields
    newBlockField: link.config?.new_block_field,
}));
```

### 14. Landing View Data Mapping

**File:** `resources/js/Pages/LandingView.tsx`

```typescript
const links: LinkBlock[] = serverLinks.map((link) => ({
    // ... existing fields
    newBlockField: link.config?.new_block_field,
}));
```

## Quick Summary: Files to Update

| Step | File | Action |
|------|------|--------|
| 1 | `config/blockConfig.ts` | Add BLOCK_TYPES entry (label, icon, defaults) |
| 2 | `types.ts` | Add BlockType + specific types + LinkBlock fields |
| 3 | `SaveLinksRequest.php` | Add validation + extractConfig |
| 4 | `BlockTypes.php` | Add constant (optional) |
| 5 | `useLinkValidation.ts` | Add validation logic |
| 6 | `configs/{Name}Config.tsx` | Create config component |
| 7 | `configs/index.ts` | Export config |
| 8 | `LinkConfigDialog.tsx` | Add switch case |
| 9 | `blocks/{Name}Block.tsx` | Create renderer |
| 10 | `blocks/index.ts` | Export renderer |
| 11 | `LandingContent.tsx` | Add render logic |
| 12 | `Dashboard.tsx` linksPayload | **Add ALL new fields** |
| 13 | `Dashboard.tsx` initialLinks | Map config fields |
| 14 | `LandingView.tsx` | Map config fields |

## Block Types Reference

### Existing Blocks (Implemented)

| Type         | Config           | Renderer        | Status |
| ------------ | ---------------- | --------------- | ------ |
| `link`       | DefaultConfig    | Standard button | Done   |
| `header`     | DefaultConfig    | Text divider    | Done   |
| `whatsapp`   | WhatsAppConfig   | WhatsApp button | Done   |
| `calendar`   | CalendarConfig   | CalendarBlock   | Done   |
| `youtube`    | MediaConfig      | Embed/Button    | Done   |
| `spotify`    | MediaConfig      | Embed/Button    | Done   |
| `email`      | EmailConfig      | EmailBlock      | Done   |
| `map`        | MapConfig        | MapBlock        | Done   |
| `vimeo`      | VideoEmbedConfig | VimeoBlock      | Done   |
| `tiktok`     | VideoEmbedConfig | TikTokBlock     | Done   |
| `soundcloud` | SoundCloudConfig | SoundCloudBlock | Done   |
| `twitch`     | VideoEmbedConfig | TwitchBlock     | Done   |

## Testing Workflow

1. Create block via UI (Add Block button)
2. Configure in panel (click Configure)
3. Verify preview updates in PhonePreview
4. Check auto-save triggers (see "Cambios pendientes" -> saved)
5. Reload page, verify data persists
6. Visit public landing `/{handle}`, verify rendering
7. Test validation errors (empty fields, invalid URLs)

## Style Guidelines

### Config Components

- Use `space-y-5` for vertical spacing
- Labels: `text-xs font-bold text-neutral-500 uppercase tracking-wider`
- Inputs: `bg-neutral-50 dark:bg-neutral-800 border rounded-xl px-4 py-3`
- Info boxes: `p-4 bg-neutral-100 dark:bg-neutral-800 rounded-xl` (gray neutral style)

### Block Renderers

- Accept `buttonClassName`, `buttonStyle`, `roundingClass` from parent
- Support `isPreview` mode (disable clicks)
- Use `animate-in slide-in-from-bottom-2 fade-in` animations
- Support `animationDelay` for staggered entry
- Icons from `lucide-react`

## Icons

### Lucide Icons vs Legacy Icons

- **Lucide Icons**: Stored as `{ type: "lucide", name: "icon-name" }`
- **Legacy Icons**: Stored as `{ type: "folder", name: "filename" }` (SVGs in `/assets/images/icons/`)

The helper function `isLegacyIcon()` in `utils/iconHelper.tsx` distinguishes between them.

When a block is created:
1. `createBlockDefaults()` from `blockConfig.ts` sets the default icon
2. The icon uses `{ type: "lucide", name: config.iconName }`
3. `LinkCard` renders using the `config.icon` Lucide component
4. Users can override with a legacy icon via IconSelector

## Legacy Reference

Check legacy implementations in:

- `_legacy_lumen/admin/src/app/pages/landings/components/blockTypes/components/`
- `_legacy_lumen/resources/views/components/landing/buttons-link.blade.php`
